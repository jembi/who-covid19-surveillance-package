{
  "name": "Covid19 DHIS2 Orchestrator",
  "description": "Endpoint for mapping the Covid19 case report into DHIS format and then forwarding it to DHIS2",
  "endpoint": {
    "pattern": "/resource-resolver-dhis"
  },
  "transformation": {
    "input": "JSON",
    "output": "JSON"
  },
  "inputValidation": {
    "type": "object",
    "properties": {
      "requestBody": {
        "type": "object"
      }
    },
    "required": ["requestBody"]
  },
  "inputMapping": {
    "requestBody.data.identifier": "teiIdentifier",
    "constants.program": "program",
    "constants.orgUnit": "orgUnit",
    "constants.trackedEntityType": "trackedEntityType",
    "constants.status": "event.status",
    "constants.stage": "event.programStage",
    "requestBody.data.observations[1].value.valueCodeableConcept.coding[0].code": {
      "key": "attributes[]+",
      "transform": {
        "function": "mapCodes",
        "parameters": {
          "male": {
            "attribute": "oindugucx72",
            "value": "Male"
          },
          "female": {
            "attribute": "oindugucx72",
            "value": "Female"
          }
        }
      }
    },
    "transforms.patinfo_ID": "attributes[]+",
    "transforms.patinfo_ageonset": "attributes[]+",

    "transforms.incidentDate": {
      "key": "incidentDate",
      "transform": {
        "function": "dateTimeToDate"
      }
    },

    "requestBody.data.observations[3].value.valueCodeableConcept.coding[0].code": {
      "key": "event.dataValues[]+",
      "transform": {
        "function": "mapCodes",
        "parameters": {
          "Y": {
            "dataElement": "JGnHr6WI3AY",
            "value": "Yes"
          },
          "N": {
            "dataElement": "JGnHr6WI3AY",
            "value": "No"
          },
          "U": {
            "dataElement": "JGnHr6WI3AY",
            "value": "Unknown"
          }
        }
      }
    },
    "requestBody.data.observations[5].value.valueCodeableConcept.coding[0].code": {
      "key": "event.dataValues[]+",
      "transform": {
        "function": "mapCodes",
        "parameters": {
          "Y": {
            "dataElement": "sJeIFfhX8BE",
            "value": "Yes"
          },
          "N": {
            "dataElement": "sJeIFfhX8BE",
            "value": "No"
          },
          "U": {
            "dataElement": "sJeIFfhX8BE",
            "value": "Unknown"
          }
        }
      }
    },
    "requestBody.data.observations[6].value.valueCodeableConcept.coding[0].code": {
      "key": "event.dataValues[]+",
      "transform": {
        "function": "mapCodes",
        "parameters": {
          "Y": {
            "dataElement": "TzqawmlPkI5",
            "value": "Yes"
          },
          "N": {
            "dataElement": "TzqawmlPkI5",
            "value": "No"
          },
          "U": {
            "dataElement": "TzqawmlPkI5",
            "value": "Unknown"
          }
        }
      }
    },
    "transforms.patcourse_dateonset": "event.dataValues[]+"
  },
  "inputTransforms": {
    "patinfo_ID": "{ 'attribute': constants.attributes.patinfo_ID, 'value': requestBody.data.identifier }",
    "patinfo_ageonset": "{ 'attribute': constants.attributes.patinfo_ageonset, 'value': requestBody.data.observations[0].value.valueQuantity.value }",

    "incidentDate": "$now()",

    "patcourse_dateonset": "{ 'dataElement': constants.dataElements.patcourse_dateonset, 'value': requestBody.data.observations[4].value.valueDateTime }"
  },
  "requests": {
    "response": [
      {
        "primary": true,
        "id": "dhis-file-queue",
        "config": {
          "method": "POST",
          "url": "http://file-queue:4002/covid19-case-report",
          "headers": {
            "Content-Type": "application/json"
          }
        }
      }
    ]
  },
  "constants": {
    "program": "uYjxkTbwRNf",
    "orgUnit": "ImspTQPwCqd",
    "stage": "LpWNjNGvCO5",
    "trackedEntityType": "MCPQUTHX1Ze",
    "status": "ACTIVE",
    "attributes": {
      "patinfo_ID": "he05i8FUwu3",
      "patinfo_ageonset": "Rv8WM2mTuS5"
    },
    "dataElements": {
      "patcourse_dateonset": "s3eoonJ8OJb"
    }
  }
}
